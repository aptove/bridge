#!/usr/bin/env node

const { spawnSync } = require('child_process');
const path = require('path');
const fs = require('fs');

const PLATFORM_PACKAGES = {
  'darwin-arm64': '@aptove/bridge-darwin-arm64',
  'darwin-x64':   '@aptove/bridge-darwin-x64',
  'linux-arm64':  '@aptove/bridge-linux-arm64',
  'linux-x64':    '@aptove/bridge-linux-x64',
  'win32-x64':    '@aptove/bridge-win32-x64',
};

const platformKey = `${process.platform}-${process.arch}`;
const packageName = PLATFORM_PACKAGES[platformKey];

if (!packageName) {
  console.error(`bridge: unsupported platform ${platformKey}`);
  console.error('Supported: darwin-arm64, darwin-x64, linux-arm64, linux-x64, win32-x64');
  process.exit(1);
}

const binaryName = process.platform === 'win32' ? 'bridge.exe' : 'bridge';

// Both @aptove/bridge and @aptove/bridge-<platform> live under the same
// @aptove scope directory, so the platform package is always a sibling:
//   __dirname = .../node_modules/@aptove/bridge/bin
//   platform  = .../node_modules/@aptove/bridge-darwin-arm64/bin/bridge
const shortName = packageName.split('/')[1]; // e.g. "bridge-darwin-arm64"
const siblingPath = path.join(__dirname, '..', '..', shortName, 'bin', binaryName);

let binaryPath = fs.existsSync(siblingPath) ? siblingPath : null;

// Fallback: require.resolve handles pnpm virtual stores and other layouts
if (!binaryPath) {
  try {
    const pkgJson = require.resolve(`${packageName}/package.json`);
    const candidate = path.join(path.dirname(pkgJson), 'bin', binaryName);
    if (fs.existsSync(candidate)) {
      binaryPath = candidate;
    }
  } catch (e) {
    // not found
  }
}

if (!binaryPath) {
  console.error(`bridge: platform package not installed for ${platformKey}`);
  console.error('');
  console.error('Run:');
  console.error(`  npm install -g ${packageName}`);
  process.exit(1);
}

const result = spawnSync(binaryPath, process.argv.slice(2), { stdio: 'inherit' });

if (result.error) {
  console.error(`bridge: failed to execute binary: ${result.error.message}`);
  console.error(`  Binary: ${binaryPath}`);
  process.exit(1);
}

process.exit(result.status ?? 1);
